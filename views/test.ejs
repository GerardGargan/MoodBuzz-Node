<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">
    <link href="/style.css" rel="stylesheet">
    <title>Record a snapshot</title>
</head>

<body>
    <!-- Navigation menu -->
    <%- include('user_nav'); %>

        <div class="window">
            <div class="window-container-large px-sm-5 mx-sm-5">
                <h2 class="mb-5">Record a new snapshot</h2>
                <h4>1. Record your current level of emotion for each of the seven universal emotions.</h4>
                <form method="get" action="/newsnap">
                    <div class="row g-4 mt-3" id="insertEmotionRanges">
                        <!-- place data here -->
                        <% groupedData.forEach(emotion => { %>
                                <div class="col-xl-6 col-xxl-4 py-3 m-0">
                                    <div class="box-shadow bg-dark-subtle py-3 px-4 rounded">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <label for="<%= emotion.emotion %>" class="form-label">
                                                <h4>Level of <%= emotion.emotion %></h4>
                                            </label>
                                            <div id="<%= emotion.emotion %>-val-display">
                                                <h3 class="bg-dark text-light p-3 rounded">5</h3>
                                            </div>
                                        </div>

                                        <input type="range" name="emo<%= emotion.emotion_id %>" id="<%= emotion.emotion %>" class="form-range" min="1"
                                            max="10" value="5">
                                        <div class="graduated-scale">
                                            <% emotion.rating.forEach(rating => { %>
                                                <span><%= rating.rating %></span>
                                            <% }) %>
                                        </div>
                                    </div>
                                </div>
                                <% }); %>
                    </div>
                    <h4 class="mt-4">2. Select any contextual triggers</h3>
                        <div class="row mt-4">
                            <div class="d-flex gap-3 flex-wrap" id="triggers">
                                <!-- Insert triggers here -->
                                <% triggerData.forEach(trigger => { %>
                                    <input type="checkbox" class="btn-check" name="trig<%= trigger.trigger_id %>" id="<%= trigger.trigger_name %>" autocomplete="off" unchecked>
                                    <label class="btn btn-outline-primary" for="<%= trigger.trigger_name %>"><%= trigger.trigger_name %> <i class="bi <%= trigger.icon %>"></i></label>
                                <% }); %>
                            </div>
                            <!-- Display an icon (loaded from database), icon is accompanied by a description, once clicked it adds the id to an array - but how do we send in the form data? -->
                        </div>
                        <h4 class="mt-4">3. Record any notes</h4>
                        <div class="row mt-4">
                            <textarea name="notes" id="notes" placeholder="Enter notes" rows="5"></textarea>
                        </div>
                        <input type="Submit" value="Save Snapshot" class="btn btn-xl btn-success mt-5">
                        <button class="btn mt-5 btn-xl btn-primary" id="resetbutton">Reset</button>
                </form>
            </div>
        </div>

        <!-- Footer -->
        <%- include('footer'); %>

            <script>
                //obtain grouped data object from the backend
                const emotionsData = decodeURIComponent('<%- groupedData %>');
                //get all range elements on the page
                const rangeItems2 = document.querySelectorAll('input[type="range"]');
                //loop through each range element, add an input event listener so that when the slider is moved, we update the div showing the current number selected
                rangeItems2.forEach((range) => {
                    range.addEventListener('input', (event) => {
                        let displayVal = document.getElementById(`${range.id}-val-display`);
                        displayVal.innerHTML = `<h3 class="bg-dark text-light p-3 rounded">${range.value}</h3>`;
                    })
                })
                
                //obtain the reset button, range sliders, checkboxes and notes input elements
                const resetButton = document.getElementById('resetbutton');
                const rangeItems = document.querySelectorAll('input[type="range"]');
                const checkboxes = document.querySelectorAll('input[type="checkbox"]');
                const notes = document.getElementById('notes');

                //add an event listener to the reset button for a click event
                resetButton.addEventListener('click', (event) => {
                    //prevent the default behaviour of a button to submit the form
                    event.preventDefault();
                    //loop through all range sliders and reset to the default of 5
                    rangeItems.forEach((rangeItem) => {
                        const valueDiv = document.getElementById(`${rangeItem.id}-val-display`);
                        rangeItem.value = 5;
                        valueDiv.innerHTML = `<h3 class="bg-dark text-light p-3 rounded">5</h3>`;
                    });

                    //reset all checkboxes to unchecked
                    checkboxes.forEach((checkbox) => {
                        checkbox.checked = false;
                    });
                    
                    //set notes to be empty
                    notes.value = '';
                });

            </script>

            <script>
                function getCurrentDateTime() {
                    let currentDate = new Date();

                    let year = currentDate.getFullYear();
                    let month = currentDate.getMonth() + 1;
                    let date = currentDate.getDate();

                    let hours = currentDate.getHours();
                    let minutes = currentDate.getMinutes();
                    let seconds = currentDate.getSeconds();

                    let formattedDate = `${date}/${month}/${year}`;
                    let formattedTime = `${hours}:${minutes}:${seconds}`;

                    return `${formattedDate} ${formattedTime}`;
                }

            </script>
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
                integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
                crossorigin="anonymous"></script>

</body>

</html>